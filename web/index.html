<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title></title>
    <link
      rel="stylesheet"
      href="https://unpkg.com/@picocss/pico@latest/css/pico.min.css"
    />
    <style>
      .closed {
        opacity: 0.5;
      }
    </style>
  </head>

  <body class="container" x-data>
    <main>
      <p>
        <template x-if="$store.issues.list.length == 0">
          Loading <i aria-busy="true"></i>
        </template>

        <template x-if="$store.issues.list.length > 0">
          <span><span x-text="$store.issues.list.length"></span> issues</span>
        </template>
      </p>

      <template x-for="issue in $store.issues.list">
        <details :class="{closed: issue.state === 'closed'}">
          <summary x-text="issue.title"></summary>
          <a href="#" role="button" @click.prevent="$store.issues.close(issue)"
            >Close</a
          >
          <div x-html="issue.body"></div>
        </details>
      </template>
    </main>

    <script type="module">
      // TODO inject this
      const token = "XXX";
      const repository = "XXX";

      import { Octokit, App } from "https://cdn.skypack.dev/octokit";
      import Alpine from "https://cdn.skypack.dev/alpinejs";

      const octokit = new Octokit({ auth: token });
      const [owner, repo] = repository.split("/");

      window.Alpine = Alpine;

      document.addEventListener("keyup", function (event) {
        switch (event.code) {
          case "KeyJ":
            Alpine.store("issues").move(1);
            break;
          case "KeyK":
            Alpine.store("issues").move(-1);
            break;
          case "KeyC":
            Alpine.store("issues").close();
            break;
        }
      });

      Alpine.store("issues", {
        list: [],
        index: -1,
        open() {
          console.log(this.list[this.index]);
        },
        move(increment) {
          this.index += increment;
          document.querySelectorAll("details").forEach((x, i) => {
            if (i === this.index) {
              x.setAttribute("open", true);
              x.scrollIntoView();
            } else {
              x.removeAttribute("open");
            }
          });
        },
        fetch() {
          octokit
            .paginate(octokit.rest.issues.listForRepo, {
              owner: owner,
              repo: repo,
              state: "open",
            })
            .then(
              (issues) =>
                (this.list = issues.filter(
                  (issue) =>
                    issue.body &&
                    issue.body.length != 0 &&
                    issue.pull_request === undefined
                ))
            )
            .catch((e) => {
              alert(`[E] ${e}`);
            });
        },

        close(issue) {
          issue = issue || this.list[this.index];
          issue.state = "closed";
          octokit.rest.issues
            .update({
              owner: owner,
              repo: repo,
              issue_number: issue.number,
              state: "closed",
            })
            .then(console.log)
            .catch((e) => {
              alert(`[E] ${e}`);
            });
        },
      });

      Alpine.start();

      Alpine.store("issues").fetch();
    </script>
  </body>
</html>
